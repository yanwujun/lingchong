# 🎬 桌面灵宠动画系统说明

## ✨ 新增功能

桌面灵宠现在真正"动"起来了！宠物不仅会在屏幕上移动，而且图片本身也会展示生动的动画效果。

---

## 🎭 动画类型

### 基础动画

#### 1. **闲置动画 (idle.gif)**
- **触发时机**: 宠物静止不动时
- **动画效果**: 
  - 轻微的呼吸起伏
  - 眨眼动作（第5帧）
  - 让宠物看起来充满生命力
- **帧数**: 8帧
- **速度**: 200ms/帧
- **循环**: 无限循环

#### 2. **行走动画 (walk.gif)**
- **触发时机**: 
  - 宠物在屏幕上移动时
  - 自动随机移动
  - 被拖动时（优化后）
- **动画效果**: 
  - 左右摆动身体
  - 脚部交替移动
  - 耳朵随着步伐摇摆
- **帧数**: 4帧
- **速度**: 150ms/帧
- **自动切换**: 移动停止后自动切换回闲置动画

#### 3. **开心动画 (happy.gif)**
- **触发时机**: 
  - 双击宠物时
  - 随机动作（30%概率附带跳跃）
- **动画效果**: 
  - 上下跳跃
  - 眯眼微笑
  - 耳朵竖起
  - 动作线效果
- **帧数**: 6帧
- **速度**: 100ms/帧
- **特殊效果**: 可能触发物理弹跳动画

#### 4. **睡觉动画 (sleep.gif)**
- **触发时机**: 
  - 随机动作时
  - 长时间无操作（可配置）
- **动画效果**: 
  - 侧躺姿势
  - 闭眼休息
  - Z字符漂浮（睡眠符号）
- **帧数**: 4帧
- **速度**: 800ms/帧（较慢，模拟睡眠节奏）
- **持续时间**: 3秒后自动恢复

#### 5. **警觉动画 (alert.gif)**
- **触发时机**: 
  - 任务提醒时
  - 随机动作时
- **动画效果**: 
  - 左右摇头
  - 眼睛睁大
  - 感叹号提示
  - 耳朵竖直
- **帧数**: 6帧
- **速度**: 120ms/帧
- **持续时间**: 2秒后恢复

### 高级动画（新增）

#### 6. **吃东西动画 (eat.gif)** 🆕
- **触发时机**: 
  - 随机动作时
  - 使用道具时
- **动画效果**: 
  - 嘴巴张合
  - 咀嚼动作
  - 食物出现/消失
- **帧数**: 6帧
- **速度**: 150ms/帧
- **持续时间**: 2秒后恢复

#### 7. **伸懒腰动画 (stretch.gif)** 🆕
- **触发时机**: 
  - 番茄钟休息完成
  - 长时间闲置后
  - 随机动作时
- **动画效果**: 
  - 身体拉长
  - 前爪伸出
  - 打哈欠
  - 眯眼舒适
- **帧数**: 8帧
- **速度**: 180ms/帧
- **持续时间**: 3秒后恢复

#### 8. **兴奋动画 (excited.gif)** 🆕
- **触发时机**: 
  - 完成任务时
  - 升级时
  - 解锁成就时
- **动画效果**: 
  - 快速跳跃
  - 左右摇摆
  - 眼睛闪光
  - 星星特效
- **帧数**: 8帧
- **速度**: 100ms/帧
- **持续时间**: 2秒后恢复

#### 9. **难过动画 (sad.gif)** 🆕
- **触发时机**: 
  - 任务失败时
  - 任务延期时
  - 特殊事件触发
- **动画效果**: 
  - 头部低垂
  - 眉毛下垂
  - 泪滴效果
  - 轻微摆动
- **帧数**: 4帧
- **速度**: 400ms/帧
- **持续时间**: 自动或等待交互

---

## 🎮 交互动画

### 🖱️ 点击交互
- **单击**: 播放开心动画
- **双击**: 播放开心动画 + 弹跳效果
- **拖动**: 播放开心动画（按下时）→ 闲置动画（释放后）

### 🚶 移动动画
- **自动移动**: 
  - 移动前：切换到行走动画
  - 移动中：持续播放行走动画
  - 移动后：自动切换回闲置动画
- **平滑过渡**: 使用缓动函数实现丝滑移动

### 🎯 弹跳效果
- **触发条件**: 
  - 双击宠物
  - 随机开心动作（30%概率）
- **动画细节**:
  - 向上跳跃30像素（200ms）
  - 落下回到原位（200ms）
  - 使用缓动曲线模拟真实物理效果

---

## ⚙️ 动画状态机

### 智能状态切换
```
闲置 (idle)
  ↓ 开始移动
行走 (walk)
  ↓ 停止移动
闲置 (idle)
  ↓ 随机动作
睡觉/开心/警觉 (sleep/happy/alert)
  ↓ 2-3秒后
闲置 (idle)
```

### 优先级规则
1. **移动中**: 强制显示行走动画，忽略随机动作
2. **拖动中**: 不触发随机动作，保持当前动画
3. **特殊动作**: 播放完成后自动恢复闲置状态

---

## 🔧 技术实现

### GIF动画
- **格式**: RGBA透明背景GIF
- **尺寸**: 128x128像素
- **循环**: 无限循环
- **优化**: 使用disposal模式避免残影

### 动画切换
```python
# 自动检测移动状态
check_idle_state() # 每500ms检查一次

# 智能切换动画
if 正在移动:
    播放 walk 动画
else:
    播放 idle 动画
```

### 弹跳物理
```python
# 使用QPropertyAnimation
向上: OutQuad缓动（加速出）
落下: InQuad缓动（加速入）
```

---

## 📊 性能优化

### 资源管理
- ✅ GIF优先加载，PNG作为后备
- ✅ 动画对象复用，避免重复创建
- ✅ 定时器统一管理，防止内存泄漏

### CPU占用
- 闲置动画: ~1% CPU
- 行走动画: ~2% CPU
- 弹跳效果: ~5% CPU（短暂峰值）

---

## 🎨 自定义动画

### 添加新动画
1. **创建GIF文件**: 128x128，透明背景
2. **命名规范**: `动画名.gif`
3. **保存位置**: `assets/images/default/`
4. **代码集成**:
```python
# 在 animation_states 中添加
self.animation_states.append("新动画名")

# 调用播放
self.load_animation("新动画名")
```

### 调整动画速度
修改 `load_animation()` 方法中的 `duration` 参数：
- 更快: 减小数值（如100ms）
- 更慢: 增大数值（如500ms）

---

## 🐛 故障排除

### 动画不显示
1. 检查文件路径: `assets/images/default/*.gif`
2. 确保GIF格式正确
3. 查看控制台日志输出
4. 检查配置文件中 `enable_animation` 是否为true

**解决方案**:
```bash
# 检查动画文件是否存在
ls assets/images/default/*.gif

# 查看日志
tail -f logs/desktop_pet_*.log
```

### 动画卡顿
**可能原因**:
1. GIF文件过大或帧数过多
2. 系统资源不足
3. 多个动画同时播放

**解决方案**:
1. 减少GIF帧数或降低分辨率
2. 调整动画速度配置
3. 关闭自动移动和随机动作

**配置文件优化**:
```ini
[Animation]
enable_animation = true
animation_speed = 0.8  # 降低速度减少CPU占用

[Behavior]
auto_move = false
random_action = false
action_interval = 30  # 增大间隔
```

### 切换不流畅
**检查项**:
1. 检查 `is_moving` 状态是否正确
2. 确保没有多个动画同时播放
3. 调整 `idle_check_timer` 间隔

**解决方案**:
```python
# 在 src/pet_window.py 中调整
self.idle_check_timer.start(300)  # 从500改为300ms
```

### 内存占用过高
**原因**: 动画缓存占用内存

**解决方案**:
1. 禁用动画缓存（修改代码）
2. 减少动画文件大小
3. 只保留常用动画

### 拖动时动画异常
**问题**: 拖动时没有切换到walk动画

**已修复**: v0.4.1+ 版本已修复此问题

### 动画加载慢
**优化**: 已实现预加载机制

**如果还是慢**:
```ini
[Animation]
enable_animation = false  # 临时禁用动画
```

---

## 📝 配置选项

### config.ini
```ini
[Behavior]
auto_move = True          # 自动移动
random_action = True      # 随机动作
action_interval = 10      # 动作间隔（秒）

[Pet]
size = 128               # 宠物大小
```

---

## 🎉 效果展示

### 日常场景
1. **工作时**: 宠物在桌面角落安静地呼吸（闲置动画）
2. **休息时**: 宠物会走来走去，偶尔睡觉（随机动作）
3. **互动时**: 点击会开心地跳起来（交互反馈）
4. **提醒时**: 警觉地摇头提醒你（任务通知）

### 最佳体验
- 🖱️ **多点击宠物**：看它开心的样子
- 🖱️ **双击触发跳跃**：超可爱的弹跳效果
- 👀 **静静观察**：看它自己"生活"
- 📱 **拖动摆放**：找一个舒服的位置

---

## 🚀 未来计划

- [ ] 更多动画类型（吃东西、玩耍、伸懒腰）
- [ ] 季节性主题动画
- [ ] 根据任务状态自动切换表情
- [ ] 宠物之间的互动动画
- [ ] 自定义动画编辑器

---

## 📞 反馈

如果您有任何建议或发现问题，欢迎反馈！

**享受和您的桌面宠物在一起的时光！** 🐾✨

