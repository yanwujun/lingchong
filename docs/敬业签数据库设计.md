# 敬业签功能 - 数据库设计文档

**版本**：v0.5.0  
**更新日期**：2025-01-13  
**状态**：设计阶段

---

## 1. 概述

本文档描述敬业签功能集成所需的数据库表结构设计。所有表使用SQLite数据库，与现有系统兼容。

---

## 2. 新增表结构

### 2.1 便签表 (notes)

**用途**：存储用户创建的便签内容

```sql
CREATE TABLE IF NOT EXISTS notes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    content TEXT,  -- 富文本内容（HTML格式）
    category_id INTEGER,  -- 分类ID，可为空
    is_pinned BOOLEAN DEFAULT 0,  -- 是否置顶
    is_locked BOOLEAN DEFAULT 0,  -- 是否锁定
    color TEXT DEFAULT '#FFFFFF',  -- 便签颜色
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,
    FOREIGN KEY (category_id) REFERENCES note_categories(id) ON DELETE SET NULL
)
```

**字段说明**：
- `id`: 主键
- `title`: 便签标题
- `content`: 富文本内容，使用HTML格式存储
- `category_id`: 所属分类，可为空
- `is_pinned`: 是否置顶显示
- `is_locked`: 是否锁定（防止误删）
- `color`: 便签背景颜色
- `created_at`: 创建时间
- `updated_at`: 更新时间

---

### 2.2 便签分类表 (note_categories)

**用途**：存储便签分类信息

```sql
CREATE TABLE IF NOT EXISTS note_categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    color TEXT DEFAULT '#4CAF50',  -- 分类颜色
    icon TEXT,  -- 分类图标
    parent_id INTEGER,  -- 父分类ID（支持嵌套分类）
    sort_order INTEGER DEFAULT 0,  -- 排序顺序
    created_at TEXT NOT NULL,
    FOREIGN KEY (parent_id) REFERENCES note_categories(id) ON DELETE CASCADE
)
```

**字段说明**：
- `id`: 主键
- `name`: 分类名称
- `color`: 分类显示颜色
- `icon`: 分类图标（可选）
- `parent_id`: 父分类ID，支持嵌套分类
- `sort_order`: 排序顺序
- `created_at`: 创建时间

---

### 2.3 附件表 (attachments)

**用途**：存储任务和便签的附件信息

```sql
CREATE TABLE IF NOT EXISTS attachments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    entity_type TEXT NOT NULL,  -- 'task' 或 'note'
    entity_id INTEGER NOT NULL,  -- 关联的任务ID或便签ID
    file_name TEXT NOT NULL,  -- 文件名
    file_path TEXT NOT NULL,  -- 文件存储路径
    file_size INTEGER,  -- 文件大小（字节）
    file_type TEXT,  -- 文件类型（MIME类型）
    thumbnail_path TEXT,  -- 缩略图路径（图片文件）
    upload_time TEXT NOT NULL,
    FOREIGN KEY (entity_id) REFERENCES tasks(id) ON DELETE CASCADE,
    FOREIGN KEY (entity_id) REFERENCES notes(id) ON DELETE CASCADE
)
```

**字段说明**：
- `id`: 主键
- `entity_type`: 实体类型（'task' 或 'note'）
- `entity_id`: 关联的实体ID
- `file_name`: 原始文件名
- `file_path`: 文件在系统中的存储路径
- `file_size`: 文件大小
- `file_type`: MIME类型
- `thumbnail_path`: 缩略图路径（仅图片）
- `upload_time`: 上传时间

**注意**：SQLite不支持多外键，实际实现时需要在应用层验证。

---

### 2.4 子任务表 (subtasks)

**用途**：存储任务的子任务

```sql
CREATE TABLE IF NOT EXISTS subtasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER NOT NULL,
    title TEXT NOT NULL,
    description TEXT,
    status TEXT DEFAULT 'pending',  -- 'pending', 'completed'
    priority INTEGER DEFAULT 1,  -- 1=低, 2=中, 3=高
    sort_order INTEGER DEFAULT 0,  -- 排序顺序
    created_at TEXT NOT NULL,
    completed_at TEXT,
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
)
```

**字段说明**：
- `id`: 主键
- `task_id`: 父任务ID
- `title`: 子任务标题
- `description`: 子任务描述
- `status`: 状态（'pending' 或 'completed'）
- `priority`: 优先级
- `sort_order`: 排序顺序
- `created_at`: 创建时间
- `completed_at`: 完成时间

---

### 2.5 任务依赖表 (task_dependencies)

**用途**：存储任务之间的依赖关系

```sql
CREATE TABLE IF NOT EXISTS task_dependencies (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER NOT NULL,  -- 依赖其他任务的任务
    depends_on_task_id INTEGER NOT NULL,  -- 被依赖的任务
    created_at TEXT NOT NULL,
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE,
    FOREIGN KEY (depends_on_task_id) REFERENCES tasks(id) ON DELETE CASCADE,
    UNIQUE(task_id, depends_on_task_id)  -- 防止重复依赖
)
```

**字段说明**：
- `id`: 主键
- `task_id`: 当前任务ID
- `depends_on_task_id`: 依赖的任务ID
- `created_at`: 创建时间

**约束**：
- 不能依赖自己
- 不能形成循环依赖（应用层验证）

---

### 2.6 任务模板表 (task_templates)

**用途**：存储任务模板

```sql
CREATE TABLE IF NOT EXISTS task_templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,  -- 模板名称
    title TEXT NOT NULL,  -- 任务标题模板
    description TEXT,  -- 任务描述模板
    category TEXT,  -- 默认分类
    priority INTEGER DEFAULT 1,  -- 默认优先级
    template_data TEXT,  -- JSON格式的模板数据（包含子任务等）
    usage_count INTEGER DEFAULT 0,  -- 使用次数
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
)
```

**字段说明**：
- `id`: 主键
- `name`: 模板名称
- `title`: 任务标题模板（支持变量）
- `description`: 任务描述模板
- `category`: 默认分类
- `priority`: 默认优先级
- `template_data`: JSON格式的扩展数据（子任务、标签等）
- `usage_count`: 使用次数统计
- `created_at`: 创建时间
- `updated_at`: 更新时间

---

### 2.7 提醒历史表 (reminder_history)

**用途**：记录所有提醒的执行历史

```sql
CREATE TABLE IF NOT EXISTS reminder_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER,  -- 关联的任务ID
    reminder_time TEXT NOT NULL,  -- 提醒时间
    triggered_time TEXT,  -- 实际触发时间
    status TEXT DEFAULT 'pending',  -- 'pending', 'triggered', 'snoozed', 'dismissed'
    user_action TEXT,  -- 用户操作（'completed', 'snoozed', 'dismissed'）
    snooze_count INTEGER DEFAULT 0,  -- 贪睡次数
    created_at TEXT NOT NULL,
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE SET NULL
)
```

**字段说明**：
- `id`: 主键
- `task_id`: 关联的任务ID
- `reminder_time`: 计划提醒时间
- `triggered_time`: 实际触发时间
- `status`: 状态
- `user_action`: 用户操作记录
- `snooze_count`: 贪睡次数
- `created_at`: 创建时间

---

### 2.8 提醒模板表 (reminder_templates)

**用途**：存储常用提醒时间模板

```sql
CREATE TABLE IF NOT EXISTS reminder_templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,  -- 模板名称
    remind_before_minutes INTEGER,  -- 提前多少分钟提醒
    repeat_type TEXT,  -- 'none', 'daily', 'weekly', 'monthly', 'yearly'
    repeat_rule TEXT,  -- JSON格式的重复规则
    usage_count INTEGER DEFAULT 0,  -- 使用次数
    created_at TEXT NOT NULL
)
```

**字段说明**：
- `id`: 主键
- `name`: 模板名称（如"提前15分钟"）
- `remind_before_minutes`: 提前提醒的分钟数
- `repeat_type`: 重复类型
- `repeat_rule`: JSON格式的详细重复规则
- `usage_count`: 使用次数
- `created_at`: 创建时间

---

### 2.9 视图设置表 (view_settings)

**用途**：存储用户的自定义视图设置

```sql
CREATE TABLE IF NOT EXISTS view_settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    view_type TEXT NOT NULL,  -- 'list', 'timeline', 'calendar', 'kanban'
    user_id TEXT DEFAULT 'default',  -- 用户ID（未来多用户支持）
    settings_data TEXT NOT NULL,  -- JSON格式的设置数据
    is_default BOOLEAN DEFAULT 0,  -- 是否为默认视图
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,
    UNIQUE(view_type, user_id)
)
```

**字段说明**：
- `id`: 主键
- `view_type`: 视图类型
- `user_id`: 用户ID（当前版本固定为'default'）
- `settings_data`: JSON格式的设置（字段显示、排序、筛选等）
- `is_default`: 是否为默认视图
- `created_at`: 创建时间
- `updated_at`: 更新时间

---

### 2.10 备份记录表 (backup_records)

**用途**：记录数据备份信息

```sql
CREATE TABLE IF NOT EXISTS backup_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    backup_file_path TEXT NOT NULL,  -- 备份文件路径
    backup_type TEXT DEFAULT 'manual',  -- 'manual', 'auto'
    file_size INTEGER,  -- 备份文件大小
    record_count INTEGER,  -- 备份的记录数量
    backup_time TEXT NOT NULL,
    description TEXT  -- 备份描述
)
```

**字段说明**：
- `id`: 主键
- `backup_file_path`: 备份文件完整路径
- `backup_type`: 备份类型（手动或自动）
- `file_size`: 备份文件大小
- `record_count`: 备份的记录数量
- `backup_time`: 备份时间
- `description`: 备份描述（用户可填写）

---

## 3. 现有表扩展

### 3.1 tasks表扩展

需要为tasks表添加以下字段（如果不存在）：

```sql
-- 添加任务备注字段（富文本）
ALTER TABLE tasks ADD COLUMN notes TEXT;

-- 添加任务模板ID
ALTER TABLE tasks ADD COLUMN template_id INTEGER;

-- 添加重复提醒规则
ALTER TABLE tasks ADD COLUMN repeat_rule TEXT;  -- JSON格式

-- 添加多个提醒时间点（JSON数组）
ALTER TABLE tasks ADD COLUMN reminder_times TEXT;  -- JSON格式，如 ["2025-01-13 09:00:00", "2025-01-13 14:00:00"]
```

---

## 4. 索引设计

为了提高查询性能，建议创建以下索引：

```sql
-- 便签表索引
CREATE INDEX IF NOT EXISTS idx_notes_category ON notes(category_id);
CREATE INDEX IF NOT EXISTS idx_notes_created ON notes(created_at);
CREATE INDEX IF NOT EXISTS idx_notes_pinned ON notes(is_pinned);

-- 附件表索引
CREATE INDEX IF NOT EXISTS idx_attachments_entity ON attachments(entity_type, entity_id);

-- 子任务表索引
CREATE INDEX IF NOT EXISTS idx_subtasks_task ON subtasks(task_id);
CREATE INDEX IF NOT EXISTS idx_subtasks_status ON subtasks(status);

-- 任务依赖表索引
CREATE INDEX IF NOT EXISTS idx_dependencies_task ON task_dependencies(task_id);
CREATE INDEX IF NOT EXISTS idx_dependencies_depends ON task_dependencies(depends_on_task_id);

-- 提醒历史表索引
CREATE INDEX IF NOT EXISTS idx_reminder_history_task ON reminder_history(task_id);
CREATE INDEX IF NOT EXISTS idx_reminder_history_time ON reminder_history(reminder_time);
```

---

## 5. 数据迁移

### 5.1 迁移策略

1. **向后兼容**：所有新表都是可选的，不影响现有功能
2. **渐进式迁移**：新功能逐步启用，旧数据保持不变
3. **数据验证**：添加新表时检查现有数据完整性

### 5.2 迁移脚本

在 `database.py` 的 `init_database()` 方法中添加新表创建逻辑，使用 `CREATE TABLE IF NOT EXISTS` 确保安全。

---

## 6. 文件存储

### 6.1 附件存储目录结构

```
data/
├── attachments/
│   ├── tasks/
│   │   └── {task_id}/
│   │       ├── {file_name}
│   │       └── thumbnails/
│   └── notes/
│       └── {note_id}/
│           ├── {file_name}
│           └── thumbnails/
└── backups/
    └── {timestamp}_backup.json
```

### 6.2 文件命名规则

- 附件文件：`{timestamp}_{original_name}`
- 缩略图：`thumb_{original_name}.jpg`
- 备份文件：`backup_{timestamp}.json`

---

## 7. 数据完整性约束

### 7.1 外键约束

- 所有外键使用 `ON DELETE CASCADE` 或 `ON DELETE SET NULL`
- 应用层需要验证循环依赖

### 7.2 数据验证

- 文件大小限制（建议单文件 < 10MB）
- 文件类型白名单
- 便签内容长度限制（建议 < 1MB）
- 分类名称唯一性

---

## 8. 性能优化建议

1. **定期清理**：删除超过30天的提醒历史记录
2. **附件压缩**：大图片自动生成缩略图
3. **分页查询**：列表查询使用LIMIT和OFFSET
4. **缓存策略**：常用数据缓存到内存

---

**文档版本**：v1.0  
**最后更新**：2025-01-13  
**维护者**：项目团队

