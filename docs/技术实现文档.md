# 桌面灵宠 - 技术实现文档（活文档）

**当前版本**：v0.5.0  
**最后更新**：2025-01-13  
**维护说明**：本文档会随功能开发持续更新

---

## 📋 文档说明

### 状态标记
- ✅ **已完成** - 功能已实现并测试通过
- 🚧 **开发中** - 正在开发
- ⏳ **计划中** - 已规划但未开始
- ❌ **已取消** - 不再实现
- ⚠️ **部分完成** - 基础功能已实现，但需要完善

### 版本标记
- `[v0.1.0]` - MVP 版本实现
- `[v0.2.0]` - Beta 优化版实现
- `[v0.3.0]` - 增强版实现
- `[v0.4.0]` - 智能成长版实现
- `[v0.5.0]` - 敬业签增强版实现

---

## 1. 核心功能实现

### 1.1 宠物窗口系统 ✅ [v0.1.0]

**文件**：`src/pet_window.py`

**关键实现**：
- 透明窗口：`setAttribute(Qt.WA_TranslucentBackground)`
- 无边框置顶：`setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint)`
- 拖拽移动：`mousePressEvent` + `mouseMoveEvent`
- 动画播放：`QMovie` (GIF) 或 `QPixmap` (PNG)

**状态**：✅ 完全实现

---

### 1.2 待办事项管理 ✅ [v0.1.0]

**文件**：`src/todo_window.py`

**功能**：
- 任务增删改查 ✅
- 任务搜索 ✅ [v0.2.0]
- 任务编辑 ✅ [v0.2.0]
- 快捷键支持 ✅ [v0.2.0]

**状态**：✅ 完全实现

---

### 1.3 提醒系统 ✅ [v0.1.0]

**文件**：`src/reminder.py`

**功能**：
- 定时检查 ✅
- 弹窗提醒 ✅
- 宠物动画提醒 ✅
- 贪睡功能 ✅

**状态**：✅ 完全实现

---

### 1.4 数据库系统 ✅ [v0.1.0]

**文件**：`src/database.py`

**表结构**：15个表
- `tasks` - 任务表
- `pets` - 宠物表 [v0.4.0]
- `achievements` - 成就表 [v0.4.0]
- `inventory` - 背包表 [v0.4.0]
- 等...

**状态**：✅ 完全实现

---

## 2. v0.4.0 新增功能

### 2.1 番茄钟系统 ✅ [v0.4.0]

**文件**：`src/pomodoro_core.py`, `src/pomodoro_window.py`

**功能**：
- 计时器功能 ✅
- 桌面小组件 ✅
- 专注模式 ✅
- 统计报表 ✅

**状态**：✅ 完全实现

---

### 2.2 宠物成长系统 ✅ [v0.4.0]

**文件**：`src/pet_growth.py`

**功能**：
- 经验值系统 ✅
- 等级系统 ✅
- 4维属性 ✅
- 进化系统 ✅

**状态**：✅ 完全实现

---

### 2.3 AI对话系统 ✅ [v0.4.0]

**文件**：`src/ai_chat.py`, `src/chat_window.py`

**功能**：
- OpenAI集成 ✅
- 智能对话 ✅
- 3种性格 ✅
- 对话历史 ✅

**状态**：✅ 完全实现

---

### 2.4 图片识别系统 ✅ [v0.4.0]

**文件**：`src/image_recognizer.py`

**功能**：
- Vision API集成 ✅
- 拖放识别 ✅
- 自动生成任务 ✅

**状态**：✅ 完全实现

---

## 3. v0.5.0 敬业签功能集成

### 3.1 便签系统 ⏳ [v0.5.0]

**文件**：`src/note_window.py`, `src/note_editor.py`

**功能**：
- 富文本编辑 ⏳
- 图片附件 ⏳
- 文件附件 ⏳
- 便签分类 ⏳
- 便签搜索 ⏳
- 便签排序 ⏳

**状态**：⏳ 计划中

**技术要点**：
- 使用 `QTextEdit` 实现富文本编辑
- 使用 `QTextDocument` 处理格式化文本
- 附件存储在 `attachments/` 目录
- 数据库表：`notes`, `note_categories`, `attachments`

---

### 3.2 增强待办功能 ⏳ [v0.5.0]

**文件**：`src/todo_window.py` (增强), `src/subtask_manager.py`

**功能**：
- 子任务系统 ⏳
- 任务附件 ⏳
- 任务依赖 ⏳
- 任务模板 ⏳
- 批量操作 ⏳

**状态**：⏳ 计划中

**技术要点**：
- 子任务使用树形结构存储
- 任务依赖使用有向无环图（DAG）验证
- 模板系统支持变量替换

---

### 3.3 视图系统 ⏳ [v0.5.0]

**文件**：`src/timeline_view.py`, `src/calendar_view.py`, `src/kanban_view.py`

**功能**：
- 时间轴视图 ⏳
- 日历视图 ⏳
- 看板视图 ⏳
- 视图切换 ⏳

**状态**：⏳ 计划中

**技术要点**：
- 时间轴使用 `QGraphicsView` 实现
- 日历视图使用 `QCalendarWidget` 或自定义绘制
- 看板视图使用 `QListWidget` 实现拖拽
- 视图状态保存到 `view_settings` 表

---

### 3.4 增强提醒系统 ⏳ [v0.5.0]

**文件**：`src/reminder.py` (增强), `src/recurring_reminder.py`

**功能**：
- 重复提醒 ⏳
- 多时间点提醒 ⏳
- 提醒模板 ⏳
- 提醒历史 ⏳

**状态**：⏳ 计划中

**技术要点**：
- 使用 `rrule` 库处理重复规则
- 提醒模板支持快速创建常用提醒
- 提醒历史记录到 `reminder_history` 表

---

### 3.5 数据管理增强 ⏳ [v0.5.0]

**文件**：`src/data_export.py`, `src/data_import.py`

**功能**：
- 数据导出 ⏳
- 数据导入 ⏳
- 数据备份 ⏳
- 数据恢复 ⏳

**状态**：⏳ 计划中

**技术要点**：
- JSON导出使用标准库 `json`
- CSV导出使用 `csv` 模块
- 备份文件包含时间戳和版本信息

---

### 3.6 快捷操作 ⏳ [v0.5.0]

**文件**：`src/global_hotkey.py`, `src/quick_input.py`, `src/command_palette.py`

**功能**：
- 全局快捷键 ⏳
- 快速输入 ⏳
- 命令面板 ⏳

**状态**：⏳ 计划中

**技术要点**：
- 全局快捷键使用 `keyboard` 库或 Windows API
- 快速输入解析器支持 `@分类 #标签 时间` 语法
- 命令面板使用模糊搜索

---

## 3. 技术要点

### 3.1 资源路径处理 ✅ [v0.2.0]

```python
def get_resource_path(relative_path):
    if hasattr(sys, '_MEIPASS'):
        return os.path.join(sys._MEIPASS, relative_path)
    return os.path.join(os.path.abspath("."), relative_path)
```

**用途**：兼容开发和打包环境

---

### 3.2 信号和槽机制

**使用场景**：
- 任务完成 → 宠物成长
- 提醒触发 → 宠物动画
- 窗口交互 → 功能菜单

---

## 4. 配置管理

### 4.1 配置文件结构

**文件**：`config.ini`

**配置段**：
- `[Pet]` - 宠物设置
- `[Window]` - 窗口设置
- `[Behavior]` - 行为设置
- `[Reminder]` - 提醒设置
- `[Database]` - 数据库设置
- `[AI]` - AI设置 [v0.4.0]

---

## 5. 数据库设计

### 5.1 核心表

**tasks表**：
- id, title, description, due_date, priority, status, category, remind_time, created_at, updated_at

**pets表** [v0.4.0]：
- id, name, pet_type, level, experience, evolution_stage, hunger, happiness, health, energy, coins

**achievements表** [v0.4.0]：
- id, pet_id, achievement_id, unlocked_at

**inventory表** [v0.4.0]：
- id, pet_id, item_id, quantity, obtained_at

---

## 6. 模块依赖关系

```
main.py
├── PetManager → PetWindow × N
├── Database (15个表)
├── TodoWindow
├── PomodoroWindow
├── ChatWindow
├── ImageRecognizer
└── SystemTray
```

---

## 7. 性能优化

### 7.1 已实现优化
- ✅ 资源路径兼容
- ✅ 延迟加载动画
- ✅ 数据库连接管理
- ✅ 异常处理机制

### 7.2 待优化
- ⏳ 资源缓存策略
- ⏳ 异步加载
- ⏳ 内存释放优化

---

## 8. 版本历史

### v0.1.0 MVP ✅
- 基础宠物窗口
- 待办管理
- 提醒系统

### v0.2.0 Beta ✅
- 编辑任务
- 搜索功能
- 快捷键支持
- 平滑动画

### v0.3.0 增强版 ✅
- 音效系统
- 主题切换
- 数据统计
- 任务标签

### v0.4.0 智能版 ✅
- 番茄钟系统
- 宠物成长系统
- AI对话系统
- 图片识别
- 成就系统
- 道具系统
- 多宠物管理

### v0.5.0 敬业签版 ⏳
- 便签系统（富文本、附件）
- 增强待办（子任务、依赖、模板）
- 多视图系统（时间轴、日历、看板）
- 增强提醒（重复、多时间点）
- 数据管理增强（导入导出）
- 快捷操作（全局快捷键、命令面板）

---

## 9. 快速参考

### 按功能查找
- **宠物窗口** → 1.1
- **待办管理** → 1.2
- **提醒系统** → 1.3
- **番茄钟** → 2.1
- **宠物成长** → 2.2
- **AI对话** → 2.3
- **图片识别** → 2.4
- **便签系统** → 3.1 [v0.5.0]
- **增强待办** → 3.2 [v0.5.0]
- **视图系统** → 3.3 [v0.5.0]
- **增强提醒** → 3.4 [v0.5.0]

### 按文件查找
- **pet_window.py** → 1.1
- **todo_window.py** → 1.2
- **database.py** → 1.4
- **pomodoro_core.py** → 2.1
- **pet_growth.py** → 2.2
- **ai_chat.py** → 2.3

---

**文档版本**：v1.1  
**最后更新**：2025-01-13  
**维护者**：项目团队  
**更新频率**：每次功能开发后更新  
**更新说明**：新增v0.5.0敬业签功能实现计划

---

> **注意**：本文档为精简版。完整实现细节请参考源代码和注释。

