# 桌面灵宠 - 开发指南

**文档版本**: v1.0  
**最后更新**: 2025-01-13

---

## 1. 环境搭建

### 1.1 环境要求
- Python 3.8 或更高版本
- Windows 10/11（推荐）
- pip 包管理器

### 1.2 安装步骤

```bash
# 1. 检查Python版本
python --version

# 2. 创建虚拟环境（推荐）
python -m venv venv

# 3. 激活虚拟环境
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# 4. 安装依赖包
pip install -r requirements.txt

# 5. 验证安装
python main.py
```

---

## 2. 项目结构

### 2.1 目录结构

```
桌面灵宠/
├── main.py                 # 主程序入口
├── requirements.txt        # 依赖包列表
├── config.ini             # 配置文件
├── README.md              # 项目说明
│
├── src/                   # 源代码目录
│   ├── __init__.py
│   ├── pet_window.py      # 宠物窗口
│   ├── todo_window.py     # 待办窗口
│   ├── settings_window.py # 设置窗口
│   ├── database.py        # 数据库操作
│   ├── reminder.py        # 提醒系统
│   ├── tray_icon.py       # 系统托盘
│   ├── utils.py           # 工具函数
│   ├── logger.py          # 日志系统
│   ├── sound_manager.py   # 音效管理
│   ├── themes.py          # 主题样式
│   ├── statistics_window.py # 统计窗口
│   ├── tutorial.py        # 新手引导
│   ├── pomodoro_core.py   # 番茄钟核心
│   ├── pomodoro_window.py # 番茄钟窗口
│   ├── pomodoro_widget.py # 番茄钟组件
│   ├── pet_growth.py      # 宠物成长系统
│   ├── pet_achievements.py # 成就系统
│   ├── pet_inventory.py   # 道具系统
│   ├── ai_chat.py         # AI对话核心
│   ├── chat_window.py     # 对话窗口
│   ├── pet_manager.py     # 多宠物管理
│   ├── pet_shop.py        # 宠物商店
│   └── image_recognizer.py # 图片识别
│
├── assets/                # 资源文件
│   ├── images/           # 图片资源
│   ├── sounds/           # 音效文件
│   └── icons/            # 图标资源
│
├── data/                 # 数据目录
│   └── tasks.db          # SQLite数据库
│
├── config/               # 配置目录
│   └── api_keys.json     # API密钥
│
├── backups/              # 备份目录
├── logs/                 # 日志目录
└── docs/                 # 文档目录
```

### 2.2 模块说明

**核心功能模块（v0.1.0）**：
- `pet_window.py` - 宠物窗口，透明、可拖动
- `todo_window.py` - 待办事项管理窗口
- `database.py` - 数据库操作，15个表
- `reminder.py` - 提醒系统

**增强功能模块（v0.2.0-v0.3.0）**：
- `sound_manager.py` - 音效管理
- `themes.py` - 主题样式
- `statistics_window.py` - 数据统计
- `tutorial.py` - 新手引导

**智能功能模块（v0.4.0）**：
- `pomodoro_core.py` - 番茄钟核心逻辑
- `pet_growth.py` - 宠物成长系统
- `pet_achievements.py` - 成就系统
- `pet_inventory.py` - 道具系统
- `ai_chat.py` - AI对话核心
- `image_recognizer.py` - 图片识别
- `pet_manager.py` - 多宠物管理

### 2.3 数据库结构

**核心表（15个）**：
1. `tasks` - 任务表
2. `config` - 配置表
3. `tags` - 标签表
4. `task_tags` - 任务标签关联表
5. `pomodoro_sessions` - 番茄钟会话表
6. `pets` - 宠物表
7. `achievements` - 成就表
8. `inventory` - 背包表
9. `chat_history` - 对话历史表
10. `image_tasks` - 图片识别记录表

---

## 3. 开发流程

### 3.1 理解项目结构（1-2小时）

1. **阅读文档**
   - 阅读 `需求规格说明书.md`
   - 阅读 `技术实现文档.md`
   - 阅读 `README.md`

2. **熟悉代码**
   - 从 `main.py` 开始
   - 查看 `src/pet_window.py` 了解窗口实现
   - 查看 `src/database.py` 了解数据操作

3. **运行测试**
   ```bash
   python main.py
   ```

### 3.2 开发新功能

1. **创建模块**
   - 在 `src/` 目录创建新文件
   - 继承相应的基类（如 `QWidget`）

2. **集成到主程序**
   - 在 `main.py` 中初始化
   - 连接信号和槽
   - 添加到菜单

3. **测试功能**
   - 运行程序测试
   - 检查日志输出
   - 验证数据持久化

### 3.3 调试技巧

```python
# 添加调试输出
print(f"[DEBUG] 当前位置: {self.pos()}")

# 使用PyQt的调试工具
from PyQt5.QtCore import qDebug
qDebug("调试信息")

# 检查资源文件
import os
animation_path = "assets/images/default/idle.gif"
print(f"文件存在: {os.path.exists(animation_path)}")
```

---

## 4. 技术要点

### 4.1 透明窗口实现

```python
self.setWindowFlags(
    Qt.FramelessWindowHint |      # 无边框
    Qt.WindowStaysOnTopHint |     # 置顶
    Qt.SubWindow                  # 子窗口
)
self.setAttribute(Qt.WA_TranslucentBackground)  # 透明背景
```

### 4.2 鼠标拖拽

```python
def mousePressEvent(self, event):
    if event.button() == Qt.LeftButton:
        self.drag_position = event.globalPos() - self.frameGeometry().topLeft()

def mouseMoveEvent(self, event):
    if event.buttons() == Qt.LeftButton:
        self.move(event.globalPos() - self.drag_position)
```

### 4.3 动画播放

```python
self.movie = QMovie("assets/images/default/idle.gif")
self.label.setMovie(self.movie)
self.movie.start()
```

### 4.4 资源路径处理

```python
import sys
import os

def get_resource_path(relative_path):
    """获取资源文件的绝对路径"""
    if hasattr(sys, '_MEIPASS'):
        # PyInstaller 创建的临时文件夹
        return os.path.join(sys._MEIPASS, relative_path)
    return os.path.join(os.path.abspath("."), relative_path)
```

---

## 5. 依赖包

### 5.1 核心依赖

```
PyQt5>=5.15.0
PyQt5-Qt5>=5.15.0
PyQt5-sip>=12.8.0
PyQt5-Multimedia>=5.15.0
```

### 5.2 AI功能依赖（v0.4.0）

```
openai>=1.0.0
requests>=2.31.0
Pillow>=10.0.0
```

---

## 6. 常见问题

### Q1: 动画不显示怎么办？
- 确认文件路径正确
- 确认文件格式（GIF）
- 确认文件没有损坏
- 检查标签大小是否足够

### Q2: 窗口不透明怎么办？
```python
self.setAttribute(Qt.WA_TranslucentBackground)
self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint)
self.setStyleSheet("background: transparent;")
```

### Q3: 打包后资源文件找不到？
使用 `get_resource_path()` 函数处理资源路径。

---

## 7. 开发规范

### 7.1 代码风格
- 使用 PEP 8 代码规范
- 函数和类添加文档字符串
- 变量命名清晰有意义

### 7.2 模块化设计
- 每个模块职责单一
- 使用信号和槽进行通信
- 避免循环依赖

### 7.3 错误处理
- 使用 try-except 捕获异常
- 记录错误日志
- 提供友好的错误提示

---

*文档版本: v1.0*  
*最后更新: 2025-01-13*  
*维护者: Desktop Pet Development Team*

